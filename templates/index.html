{% extends "base.html" %}

{% block title %}Emergency Routing System - Premium Dashboard{% endblock %}

{% block content %}
<!-- Statistics Dashboard -->
<div class="stats-dashboard">
    <div class="stat-card" style="animation-delay: 0.1s;">
        <div class="stat-icon">ğŸ¥</div>
        <div class="stat-content">
            <h3 id="totalHospitals">5</h3>
            <p>Total Hospitals</p>
        </div>
    </div>
    <div class="stat-card" style="animation-delay: 0.2s;">
        <div class="stat-icon">ğŸ“‹</div>
        <div class="stat-content">
            <h3 id="pendingCount">0</h3>
            <p>Pending Requests</p>
        </div>
    </div>
    <div class="stat-card" style="animation-delay: 0.3s;">
        <div class="stat-icon">âœ…</div>
        <div class="stat-content">
            <h3 id="acceptedCount">0</h3>
            <p>Accepted Today</p>
        </div>
    </div>
    <div class="stat-card" style="animation-delay: 0.4s;">
        <div class="stat-icon">âš¡</div>
        <div class="stat-content">
            <h3 id="responseTime">~2min</h3>
            <p>Avg Response Time</p>
        </div>
    </div>
</div>

<div class="main-container">
    <!-- LEFT PANEL - Ambulance Staff -->
    <div class="panel ambulance-panel">
        <div class="panel-header">
            <h2>ğŸš‘ Ambulance Staff Panel</h2>
        </div>
        <div class="panel-body">
            <form id="ambulanceForm">
                <div class="form-group">
                    <label for="patientType">
                        Patient Type <span class="required">*</span>
                    </label>
                    <select id="patientType" name="patient_type" required>
                        <option value="">-- Select Patient Type --</option>
                        <option value="Normal">ğŸŸ¢ Normal</option>
                        <option value="Serious">ğŸ”´ Serious</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="emergencyType">
                        Emergency Type <span class="required">*</span>
                    </label>
                    <select id="emergencyType" name="emergency_type" required>
                        <option value="">-- Select Emergency Type --</option>
                        <option value="Cardiac">â¤ï¸ Cardiac</option>
                        <option value="Accident">ğŸš— Accident</option>
                        <option value="Respiratory">ğŸ« Respiratory</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Patient Needs <span class="required">*</span></label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="need_bed" id="needBed" checked disabled>
                            <span>ğŸ›ï¸ Bed (Mandatory)</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="need_icu" id="needICU">
                            <span>ğŸ¥ ICU</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="need_oxygen" id="needOxygen">
                            <span>ğŸ’¨ Oxygen</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="need_ventilator" id="needVentilator">
                            <span>ğŸ« Ventilator</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span class="btn-icon">ğŸ”</span> Find Nearest Hospital
                </button>
            </form>

            <div id="ambulanceResponse" class="response-message"></div>
        </div>
    </div>

    <!-- RIGHT PANEL - Hospital Admin -->
    <div class="panel hospital-panel">
        <div class="panel-header">
            <h2>ğŸ¥ Hospital Admin Panel</h2>
            <button onclick="refreshRequests()" class="btn-refresh">
                <span>ğŸ”„</span> Refresh
            </button>
        </div>
        <div class="panel-body">
            <div id="pendingRequestsList">
                <p class="loading-text">Loading pending requests...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let requestCount = 0;

    // Load pending requests on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadPendingRequests();
        updateStats();
        // Auto-refresh every 10 seconds
        setInterval(() => {
            loadPendingRequests();
            updateStats();
        }, 10000);
    });

    // Update statistics
    function updateStats() {
        // This could be enhanced with real API calls
        const stats = {
            totalHospitals: 5,
            pendingCount: document.querySelectorAll('.request-card').length,
            acceptedCount: Math.floor(Math.random() * 20) + 5,
            responseTime: '~2min'
        };
        
        document.getElementById('totalHospitals').textContent = stats.totalHospitals;
        document.getElementById('pendingCount').textContent = stats.pendingCount;
        document.getElementById('acceptedCount').textContent = stats.acceptedCount;
    }

    // Handle ambulance form submission
    document.getElementById('ambulanceForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const responseDiv = document.getElementById('ambulanceResponse');
        responseDiv.innerHTML = `
            <div class="alert alert-info" style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border-left-color: #17a2b8; color: #0c5460;">
                <strong>ğŸ” Searching...</strong> Finding the nearest hospital with available facilities...
            </div>
        `;
        
        const formData = {
            patient_type: document.getElementById('patientType').value,
            emergency_type: document.getElementById('emergencyType').value,
            need_bed: true,
            need_icu: document.getElementById('needICU').checked,
            need_oxygen: document.getElementById('needOxygen').checked,
            need_ventilator: document.getElementById('needVentilator').checked
        };
        
        try {
            const response = await fetch('/ambulance/find-hospital', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                responseDiv.innerHTML = `
                    <div class="alert alert-success">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 3rem; animation: bounceIn 0.8s;">âœ“</div>
                        </div>
                        <strong style="font-size: 1.2rem;">Request Sent Successfully!</strong><br><br>
                        <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <p style="margin: 0.5rem 0;"><strong>ğŸ¥ Hospital:</strong> ${data.hospital_name}</p>
                            <p style="margin: 0.5rem 0;"><strong>ğŸ“ Distance:</strong> ${data.distance} km</p>
                            <p style="margin: 0.5rem 0;"><strong>ğŸ†” Request ID:</strong> #${data.request_id}</p>
                        </div>
                        <a href="/ambulance/status" class="btn-link" style="font-size: 1.1rem;">
                            ğŸ“Š Check Status â†’
                        </a>
                    </div>
                `;
                // Play success sound
                playSuccessAnimation();
                // Refresh hospital panel
                setTimeout(() => {
                    loadPendingRequests();
                    updateStats();
                }, 500);
            } else {
                responseDiv.innerHTML = `
                    <div class="alert alert-error">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 3rem;">âœ—</div>
                        </div>
                        <strong>Error:</strong> ${data.message}
                    </div>
                `;
            }
        } catch (error) {
            responseDiv.innerHTML = `
                <div class="alert alert-error">
                    <strong>âœ— Connection Error:</strong> Failed to connect to server. Please try again.
                </div>
            `;
        }
    });

    // Success animation
    function playSuccessAnimation() {
        // Create confetti effect
        for(let i = 0; i < 30; i++) {
            createConfetti();
        }
    }

    function createConfetti() {
        const confetti = document.createElement('div');
        confetti.style.position = 'fixed';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.background = ['#667eea', '#764ba2', '#f093fb', '#f5576c'][Math.floor(Math.random() * 4)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-10px';
        confetti.style.opacity = '1';
        confetti.style.borderRadius = '50%';
        confetti.style.pointerEvents = 'none';
        confetti.style.zIndex = '9999';
        document.body.appendChild(confetti);
        
        let pos = -10;
        const fall = setInterval(() => {
            pos += 5;
            confetti.style.top = pos + 'px';
            confetti.style.opacity = (100 - pos) / 100;
            if(pos > 100) {
                clearInterval(fall);
                confetti.remove();
            }
        }, 30);
    }

    // Load pending requests for hospital admin
    async function loadPendingRequests() {
        try {
            const response = await fetch('/hospital/pending-requests');
            const data = await response.json();
            
            const listDiv = document.getElementById('pendingRequestsList');
            
            if (data.success && data.requests.length > 0) {
                let html = '<div class="requests-container">';
                
                data.requests.forEach((req, index) => {
                    const needs = [];
                    if (req.need_bed) needs.push('ğŸ›ï¸ Bed');
                    if (req.need_icu) needs.push('ğŸ¥ ICU');
                    if (req.need_oxygen) needs.push('ğŸ’¨ Oxygen');
                    if (req.need_ventilator) needs.push('ğŸ« Ventilator');
                    
                    const urgencyIcon = req.patient_type === 'Serious' ? 'ğŸš¨' : 'ğŸ“‹';
                    
                    html += `
                        <div class="request-card" id="request-${req.id}" style="animation-delay: ${index * 0.1}s;">
                            <div class="request-header">
                                <span class="request-id">${urgencyIcon} #${req.id}</span>
                                <span class="badge badge-${req.patient_type.toLowerCase()}">${req.patient_type}</span>
                            </div>
                            <div class="request-body">
                                <p><strong>ğŸš‘ Emergency Type:</strong> ${req.emergency_type}</p>
                                <p><strong>ğŸ¥ Patient Needs:</strong> ${needs.join(', ')}</p>
                                <p><strong>ğŸ¨ Hospital:</strong> ${req.hospital_name}</p>
                                <p><strong>ğŸ“Š Status:</strong> <span class="badge badge-pending">${req.status}</span></p>
                                <p><strong>ğŸ• Time:</strong> ${req.created_at}</p>
                            </div>
                            <div class="request-actions">
                                <button onclick="acceptRequest(${req.id})" class="btn btn-accept">
                                    âœ“ Accept
                                </button>
                                <button onclick="rejectRequest(${req.id})" class="btn btn-reject">
                                    âœ— Reject
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                listDiv.innerHTML = html;
            } else {
                listDiv.innerHTML = `
                    <div class="no-requests">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“­</div>
                        <p>No pending requests at the moment.</p>
                        <p style="font-size: 0.9rem; color: #999; margin-top: 0.5rem;">All clear! ğŸ‰</p>
                    </div>
                `;
            }
            
            updateStats();
        } catch (error) {
            console.error('Error loading requests:', error);
        }
    }

    // Accept request with animation
    async function acceptRequest(requestId) {
        const card = document.getElementById(`request-${requestId}`);
        
        if (!confirm('âœ“ Are you sure you want to ACCEPT this emergency request?')) {
            return;
        }
        
        // Visual feedback
        card.style.transform = 'scale(0.95)';
        card.style.opacity = '0.6';
        
        try {
            const response = await fetch('/hospital/accept-request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ request_id: requestId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Success animation
                card.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                card.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        loadPendingRequests();
                        showNotification('âœ“ Request Accepted Successfully!', 'success');
                    }, 300);
                }, 500);
            } else {
                card.style.transform = 'scale(1)';
                card.style.opacity = '1';
                showNotification('âœ— Failed to accept request: ' + data.message, 'error');
            }
        } catch (error) {
            card.style.transform = 'scale(1)';
            card.style.opacity = '1';
            showNotification('âœ— Error accepting request', 'error');
        }
    }

    // Reject request with animation
    async function rejectRequest(requestId) {
        const card = document.getElementById(`request-${requestId}`);
        
        if (!confirm('âœ— Are you sure you want to REJECT this emergency request?')) {
            return;
        }
        
        // Visual feedback
        card.style.transform = 'scale(0.95)';
        card.style.opacity = '0.6';
        
        try {
            const response = await fetch('/hospital/reject-request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ request_id: requestId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Reject animation
                card.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
                card.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        loadPendingRequests();
                        showNotification('Request Rejected', 'warning');
                    }, 300);
                }, 500);
            } else {
                card.style.transform = 'scale(1)';
                card.style.opacity = '1';
                showNotification('âœ— Failed to reject request: ' + data.message, 'error');
            }
        } catch (error) {
            card.style.transform = 'scale(1)';
            card.style.opacity = '1';
            showNotification('âœ— Error rejecting request', 'error');
        }
    }

    // Show notification toast
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 2rem;
            border-radius: 12px;
            background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideInRight 0.5s, slideOutRight 0.5s 2.5s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // Refresh requests manually
    function refreshRequests() {
        loadPendingRequests();
        showNotification('ğŸ”„ Refreshed!', 'success');
    }
</script>

<style>
    .stats-dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px) saturate(180%);
        border-radius: 16px;
        border: 1px solid var(--glass-border);
        padding: 2rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        transition: all 0.4s ease;
        animation: fadeInUp 0.8s ease-out backwards;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.3);
    }

    .stat-icon {
        font-size: 3rem;
        animation: float 3s ease-in-out infinite;
    }

    .stat-content h3 {
        font-size: 2.5rem;
        font-weight: 800;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.3rem;
    }

    .stat-content p {
        color: white;
        font-weight: 600;
        font-size: 0.95rem;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}
